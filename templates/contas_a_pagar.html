<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Contas a Pagar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background-color: #ffffff;
      color: #000000;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
    }

    body.tema-escuro {
      background-color: #1e1e1e !important;
      color: white !important;
    }

    body.tema-escuro .form-control,
    body.tema-escuro .form-select {
      background-color: #2b2b2b !important;
      color: white !important;
      border-color: #444 !important;
    }

    body.tema-escuro .card-body,
    body.tema-escuro .card {
      background-color: #1e1e1e !important;
      color: white !important;
    }

    body.tema-escuro .btn-light {
      background-color: #444 !important;
      color: white !important;
      border: none;
    }

    body.tema-escuro .text-dark {
      color: white !important;
    }

    body.tema-escuro .bg-white {
      background-color: #1e1e1e !important;
    }

    body.tema-escuro .topo-fixo {
      background-color: #222 !important;
    }

    .menu-lateral {
      width: 220px;
      background-color: #001aff;
      padding: 30px 20px;
      min-height: 100vh;
      color: white;
    }

    .menu-lateral h2 {
      font-size: 18px;
      margin-bottom: 30px;
    }

    .menu-lateral a {
      color: white;
      text-decoration: none;
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .conteudo {
      flex: 1;
    }

    .topo-fixo {
      position: sticky;
      top: 0;
      background-color: #007bff;
      padding: 10px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }

    .topo-fixo h1 {
      margin: 0;
      font-size: 20px;
      color: white;
    }
  </style>
</head>
<body>

  <div class="menu-lateral">
    <h2>Grupo Fisgar</h2>
    <a href="/">üè† Dashboard</a>
    <a href="/contas-a-pagar">üìÅ Contas a Pagar</a>
    <a href="/compras">üßæ Compras</a>
    <a href="/produtos">üì¶ Produtos</a>
  </div>

  <div class="conteudo">

    <!-- TOPO -->
    <div class="topo-fixo d-flex justify-content-between align-items-center">
      <div class="d-flex gap-3 align-items-center">
        {% if status != 'Todos' %}
        <a href="/contas-a-pagar" class="btn btn-light btn-sm">‚Üê Voltar</a>
        {% endif %}
        <h1 style="margin: 0; font-size: 20px;">Contas a Pagar</h1>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-white btn-sm border px-3 py-1" title="Editar selecionados">‚úèÔ∏è Editar em Massa</button>
        <button type="submit" class="btn btn-white btn-sm border px-3 py-1" title="Dar baixa nos selecionados">üí∏ Baixar em Massa</button>
        <button type="submit" class="btn btn-white btn-sm border px-3 py-1" onclick="return confirm('Deseja excluir os lan√ßamentos selecionados?')" title="Excluir selecionados">üóëÔ∏è Excluir em Massa</button>
        <button class="btn btn-sm btn-light" onclick="alternarTema()" id="botao-tema" title="Alternar tema">üåô</button>
      </div>
    </div>

    <!-- FILTRO -->
    <form method="get" class="d-flex align-items-center gap-3 py-3 px-4">
      <label for="inicio" class="mb-0">De:</label>
      <input type="date" name="inicio" id="inicio" value="{{ data_inicio }}" class="form-control form-control-sm bg-white text-dark border-secondary" style="max-width: 150px;">

      <label for="fim" class="mb-0">At√©:</label>
      <input type="date" name="fim" id="fim" value="{{ data_fim }}" class="form-control form-control-sm bg-white text-dark border-secondary" style="max-width: 150px;">

      <label for="status" class="mb-0">Status:</label>
      <select name="status" id="status" class="form-select form-select-sm bg-white text-dark border-secondary" style="max-width: 180px;">
        <option value="Todos" {% if status == 'Todos' %}selected{% endif %}>Todos</option>
        <option value="Pago" {% if status == 'Pago' %}selected{% endif %}>Pago</option>
        <option value="Aberto" {% if status == 'Aberto' %}selected{% endif %}>Aberto</option>
        <option value="Pendente" {% if status == 'Pendente' %}selected{% endif %}>Pendente</option>
        <option value="Pago Parcialmente" {% if status == 'Pago Parcialmente' %}selected{% endif %}>Pago Parcialmente</option>
        <option value="atrasados" {% if status == 'atrasados' %}selected{% endif %}>Atrasados</option>
        <option value="hoje" {% if status == 'hoje' %}selected{% endif %}>Hoje</option>
      </select>

      <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
    </form>

    <!-- BOT√ÉO PDF -->
    {% if status == 'hoje' %}
    <div class="px-4 pt-2 pb-3">
      <a href="/gerar-pdf-hoje" class="btn btn-outline-dark btn-sm">
        üìÑ Gerar PDF do Dia
      </a>
    </div>
    {% endif %}

    <!-- CARDS -->
    <div class="row g-3 mx-4 mb-4">
      {% set cores = {'total': 'primary', 'pagos': 'primary', 'pendentes': 'primary', 'hoje': 'primary', 'atrasados': 'danger'} %}
      {% for chave, valor in totais.items() %}
        <div class="col-md-2 col-sm-4 col-6">
          {% if chave in ['atrasados', 'hoje'] %}
          <a href="/contas-a-pagar?status={{ chave }}" style="text-decoration: none;">
          {% endif %}
            <div class="card border border-{{ cores[chave] }} border-2 rounded-4 shadow-sm overflow-hidden"
                 style="background-color: #ffffff; min-height: 100px; transition: 0.2s ease-in-out;"
                 onmouseover="this.style.transform='scale(1.02)'"
                 onmouseout="this.style.transform='scale(1)'">
              <div class="bg-{{ cores[chave] }} text-white py-1 px-2 text-center" style="font-size: 0.8rem;">
                {{ chave | capitalize }}
              </div>
              <div class="card-body d-flex align-items-center justify-content-center fs-5 text-dark">
                {{ (valor * -1) | formatar }}
              </div>
            </div>
          {% if chave in ['atrasados', 'hoje'] %}
          </a>
          {% endif %}
        </div>
      {% endfor %}
    </div>
{% if tipos %}
<div class="mx-4 mb-3">
  <label class="fw-bold">Tipos de lan√ßamentos encontrados:</label>
  <div class="d-flex flex-wrap gap-2 mt-2">
    {% for t in tipos %}
      <span class="badge rounded-pill bg-light border text-dark px-3 py-2">
        {{ t }}
      </span>
    {% endfor %}
  </div>
</div>
{% endif %}
<!-- üîí Cabe√ßalho fixo da listagem -->
<div class="mx-4 sticky-top bg-white py-2 border-bottom text-muted small" style="z-index: 10;">
  <div class="d-flex gap-3 ps-2 fw-bold text-uppercase">
    <div style="width: 30px;"></div>
    <div style="width: 180px;">[Fornecedor]</div>
    <div style="width: 160px;">[Categoria]</div>
    <div style="width: 200px;">[Plano de Contas]</div>
    <div style="width: 160px;">[Centro de Custo]</div>
    <div style="width: 120px;">Vencimento</div>
    <div style="width: 120px;">Previsto</div>
    <div style="width: 120px;">Pago</div>
    <div style="width: 100px;">Status</div>
    <div style="width: 110px;">A√ß√µes</div>
  </div>
</div>

<!-- üßæ Listagem com checkbox + bot√µes -->
<form method="post">
  {% for item in lancamentos %}
  <div class="border border-primary rounded-4 d-flex align-items-center px-3 py-2 mb-2 mx-4 bg-white text-dark small">
    <div class="d-flex align-items-center gap-3 w-100">

      <!-- ‚úÖ Checkbox -->
      <div style="width: 30px;">
        <input type="checkbox" name="codigos" value="{{ item.codigo }}">
      </div>

      <div style="width: 180px;">
        <span style="color: #007bff;">[</span>{{ item.fornecedor }}<span style="color: #007bff;">]</span>
      </div>

      <div style="width: 160px;">
        <span style="color: #6610f2;">[</span>{{ item.categoria }}<span style="color: #6610f2;">]</span>
      </div>

      <div style="width: 200px;">
        <span style="color: #198754;">[</span>{{ item.plano }}<span style="color: #198754;">]</span>
      </div>

      <div style="width: 160px;">
        <span style="color: #fd7e14;">[</span>{{ item.centro }}<span style="color: #fd7e14;">]</span>
      </div>

      <div style="width: 120px;">
        {{ item.vencimento }}
      </div>

      <div style="width: 120px;">
        <strong>{{ item.valor | formatar }}</strong>
      </div>

      <div style="width: 120px;">
        {{ item.valor_pago | formatar }}
      </div>

      <div style="width: 100px;">
        <span class="badge
          {% if item.status == 'Pago' %}bg-success
          {% elif item.status == 'Aberto' %}bg-warning text-dark
          {% elif item.status == 'Atrasado' %}bg-danger
          {% else %}bg-secondary{% endif %}">
          {{ item.status }}
        </span>
      </div>

      <!-- üéØ Bot√µes por lan√ßamento -->
      <div class="d-flex flex-row gap-2" style="width: 110px;">
        <button class="btn btn-outline-warning btn-sm px-2 py-1" title="Editar lan√ßamento">‚úèÔ∏è</button>
        <button class="btn btn-outline-info btn-sm px-2 py-1" title="Dar baixa">üí∏</button>
        <button class="btn btn-outline-danger btn-sm px-2 py-1" title="Excluir lan√ßamento" onclick="return confirm('Excluir este lan√ßamento?')">üóëÔ∏è</button>
      </div>

    </div>
  </div>
  {% endfor %}
</form>



  </div>

  <!-- SCRIPT -->
  <script>
    function alternarTema() {
      const body = document.body;
      const btn = document.getElementById('botao-tema');
      const modoAtual = body.classList.toggle('tema-escuro');
      if (body.classList.contains('tema-escuro')) {
        btn.innerText = '‚òÄÔ∏è';
        localStorage.setItem('tema', 'escuro');
      } else {
        btn.innerText = 'üåô';
        localStorage.setItem('tema', 'claro');
      }
    }

    window.onload = () => {
      const tema = localStorage.getItem('tema');
      const body = document.body;
      const btn = document.getElementById('botao-tema');
      if (tema === 'escuro') {
        body.classList.add('tema-escuro');
        if (btn) btn.innerText = '‚òÄÔ∏è';
      }
    }
  </script>
<!-- ‚úÖ BOT√ÉO DE A√á√ÉO EM MASSA - EDITAR -->
<div class="d-flex justify-content-end gap-2 px-4 mt-3">
  <button type="button" class="btn btn-white btn-sm border px-3 py-1" title="Editar selecionados" onclick="abrirModalEditarMassa()">‚úèÔ∏è Editar em Massa</button>
</div>

<!-- ‚úÖ MODAL EDITAR EM MASSA -->
<div class="modal fade" id="modalEditarMassa" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Editar Lote Selecionado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/salvar-edicao-massa">
        <div class="modal-body">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>C√≥digo</th>
                <th>Fornecedor</th>
                <th>Categoria</th>
                <th>Plano</th>
                <th>Centro</th>
                <th>Valor</th>
                <th>Status</th>
                <th>Vencimento</th>
              </tr>
            </thead>
            <tbody id="tabela-edicao"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ‚úÖ SCRIPTS DO MODAL -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function abrirModalEditarMassa() {
  const selecionados = Array.from(document.querySelectorAll('input[name="codigos"]:checked'));
  if (selecionados.length === 0) {
    alert('Selecione ao menos um lan√ßamento para editar.');
    return;
  }

  const tabela = document.getElementById("tabela-edicao");
  tabela.innerHTML = "";

  selecionados.forEach(input => {
    const codigo = input.value;
    const linha = input.closest('.d-flex');
    const colunas = linha.querySelectorAll('div');
    const fornecedor = colunas[1]?.innerText.trim().replace('[','').replace(']','') || "";
    const categoria = colunas[2]?.innerText.trim().replace('[','').replace(']','') || "";
    const plano = colunas[3]?.innerText.trim().replace('[','').replace(']','') || "";
    const centro = colunas[4]?.innerText.trim().replace('[','').replace(']','') || "";
    const vencimento = colunas[5]?.innerText.trim() || "";
    const valor = colunas[6]?.innerText.trim().replace('R$','').replaceAll('.','').replace(',','.') || "";
    const status = colunas[8]?.innerText.trim() || "";

    tabela.innerHTML += `
      <tr>
        <td><input type="hidden" name="codigos" value="${codigo}">${codigo}</td>
        <td><input type="text" class="form-control form-control-sm" name="fornecedor_${codigo}" value="${fornecedor}"></td>
        <td><input type="text" class="form-control form-control-sm" name="categoria_${codigo}" value="${categoria}"></td>
        <td><input type="text" class="form-control form-control-sm" name="plano_${codigo}" value="${plano}"></td>
        <td><input type="text" class="form-control form-control-sm" name="centro_${codigo}" value="${centro}"></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm" name="valor_${codigo}" value="${valor}"></td>
        <td>
          <select class="form-select form-select-sm" name="status_${codigo}">
            <option ${status === 'Aberto' ? 'selected' : ''}>Aberto</option>
            <option ${status === 'Pago' ? 'selected' : ''}>Pago</option>
            <option ${status === 'Pendente' ? 'selected' : ''}>Pendente</option>
            <option ${status === 'Pago Parcialmente' ? 'selected' : ''}>Pago Parcialmente</option>
          </select>
        </td>
        <td><input type="date" class="form-control form-control-sm" name="vencimento_${codigo}" value="${formatarData(vencimento)}"></td>
      </tr>
    `;
  });

  const modal = new bootstrap.Modal(document.getElementById('modalEditarMassa'));
  modal.show();
}

function formatarData(dataBR) {
  const partes = dataBR.split("/");
  if (partes.length === 3) {
    return `${partes[2]}-${partes[1]}-${partes[0]}`;
  }
  return "";
}
</script>

</body>
</html>
