<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Novo Lan√ßamento ‚Äî Contas a Pagar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --cor-principal: #8E44AD;
    }

    body {
      background-color: #f7f9fc;
      font-family: 'Segoe UI', sans-serif;
    }

    .container-custom {
      max-width: 980px;
      margin: 40px auto;
      padding: 0 15px;
    }

    .card-form {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .titulo-form {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--cor-principal);
      margin-bottom: 20px;
      text-align: center;
    }

    label {
      font-weight: 600;
    }

    .btn-fisgar {
      background-color: var(--cor-principal);
      color: white;
      font-weight: 600;
    }

    .btn-fisgar:hover {
      background-color: #732d91;
    }

    .nf-box {
      display: none;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #ccc;
    }

    .btn-toggle-nfe {
      display: block;
      margin: 25px auto;
      background: none;
      border: 2px dashed var(--cor-principal);
      color: var(--cor-principal);
      padding: 10px 20px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-toggle-nfe:hover {
      background-color: #f1e9f8;
    }
  </style>
</head>
<body>

  <div class="container-custom">
    <div class="card-form">
      <div class="titulo-form">‚ûï Novo Lan√ßamento Manual</div>

      <form method="POST" action="/novo">
        <div class="row g-3">

          <div class="col-md-6">
            <label>Fornecedor</label>
            <input type="text" name="fornecedor" class="form-control" list="lista-fornecedores" required>
            <datalist id="lista-fornecedores">
              {% for f in fornecedores %}
                <option value="{{ f }}">
              {% endfor %}
            </datalist>
          </div>

          <div class="col-md-6">
            <label>Categoria</label>
            <select name="categoria" class="form-select" required>
              <option value="">Selecione</option>
              {% for cat in categorias %}
                <option value="{{ cat }}">{{ cat }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label>Tipo de Custo</label>
            <select name="tipo" class="form-select">
              <option value="">Selecione</option>
              <option value="Fixo">Fixo</option>
              <option value="Vari√°vel">Vari√°vel</option>
            </select>
          </div>

          <div class="col-md-4">
            <label>Centro de Custo</label>
            <input type="text" name="centro_de_custo" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Status</label>
            <select name="status" class="form-select" required>
              <option value="">Selecione</option>
              <option value="Aberto">Aberto</option>
              <option value="Pago">Pago</option>
              <option value="Vencido">Vencido</option>
            </select>
          </div>

          <div class="col-md-6">
            <label>Vencimento</label>
            <input type="date" name="vencimento" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label>Data de Emiss√£o</label>
            <input type="date" name="emissao" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Valor Total (R$)</label>
            <input type="number" step="0.01" name="valor" class="form-control" required>
          </div>

          <div class="col-md-4">
            <label>Valor Pago (R$)</label>
            <input type="number" step="0.01" name="valor_pago" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Plano de Contas</label>
            <select name="plano_de_contas" class="form-select">
              <option value="">Selecione</option>
              {% for plano in planos %}
                <option value="{{ plano }}">{{ plano }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label>Tipo</label>
            <input type="text" name="tipo" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Tipo de Pagamento</label>
            <input type="text" name="pagamento_tipo" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Tipo de Documento</label>
            <input type="text" name="documento_tipo" class="form-control">
          </div>

          <div class="col-md-12">
            <label>Documento</label>
            <input type="text" name="documento" class="form-control">
          </div>

          <div class="col-md-12">
            <label>Observa√ß√µes</label>
            <textarea name="observacoes" class="form-control" rows="3"></textarea>
          </div>

        </div>

        <!-- Expans√£o NF-e -->
        <button type="button" class="btn-toggle-nfe" onclick="document.querySelector('.nf-box').style.display='block'; this.style.display='none'">
          ‚ûï Adicionar dados da NF-e (opcional)
        </button>

        <div class="nf-box">
          <div class="row g-3">
            <div class="col-md-6">
              <label>Arquivo XML</label>
              <input type="file" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Arquivo Boleto</label>
              <input type="file" class="form-control">
            </div>
          </div>
        </div>
        <!-- Itens da Compra -->
<hr class="my-4">
<h5 class="text-center text-dark">üì¶ Itens da Compra</h5>

<div class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label>Produto</label>
    <input type="text" id="produto" class="form-control" list="lista-produtos" autocomplete="off">
    <datalist id="lista-produtos"></datalist>
  </div>
  <div class="col-md-2">
    <label>Unidade</label>
    <input type="text" id="unidade" class="form-control">
  </div>
  <div class="col-md-2">
    <label>Quantidade</label>
    <input type="number" id="quantidade" class="form-control" step="1" min="1">
  </div>
  <div class="col-md-2">
    <label>Valor Unit√°rio (R$)</label>
    <input type="number" id="valor" class="form-control" step="0.01">
  </div>
  <div class="col-md-2">
    <button type="button" class="btn btn-fisgar w-100" onclick="adicionarItem()">‚ûï Incluir</button>
  </div>
</div>

<table class="table table-sm table-bordered" id="tabela-itens">
  <thead class="table-light">
    <tr>
      <th>Produto</th>
      <th>Unidade</th>
      <th>Qtd</th>
      <th>Unit. R$</th>
      <th>Total R$</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Script para autocomplete e tabela -->
<script>
  let produtosLista = [];

  fetch('/produtos')
    .then(response => response.json())
    .then(data => {
      produtosLista = data;
      const datalist = document.getElementById("lista-produtos");
      data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.nome;
        datalist.appendChild(opt);
      });
    });

  document.getElementById("produto").addEventListener("input", function () {
    const nome = this.value;
    const produto = produtosLista.find(p => p.nome === nome);
    if (produto) {
      document.getElementById("unidade").value = produto.unidade;
      document.getElementById("valor").value = produto.preco;
    }
  });

  function adicionarItem() {
    const produto = document.getElementById("produto").value;
    const unidade = document.getElementById("unidade").value;
    const qtd = parseFloat(document.getElementById("quantidade").value);
    const valor = parseFloat(document.getElementById("valor").value);
    const total = (qtd * valor).toFixed(2);

    if (!produto || !qtd || !valor) {
      alert("Preencha todos os campos do item");
      return;
    }

    const tbody = document.querySelector("#tabela-itens tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${produto}</td>
      <td>${unidade}</td>
      <td>${qtd}</td>
      <td>R$ ${valor.toFixed(2)}</td>
      <td>R$ ${total}</td>
      <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">‚úñ</button></td>
    `;
    tbody.appendChild(tr);

    document.getElementById("produto").value = '';
    document.getElementById("unidade").value = '';
    document.getElementById("quantidade").value = '';
    document.getElementById("valor").value = '';
  }
</script>


        <!-- Bot√µes -->
        <div class="d-flex justify-content-between mt-4">
          <a href="/" class="btn btn-secondary">‚Üê Cancelar</a>
          <button type="submit" class="btn btn-fisgar">üíæ Salvar Lan√ßamento</button>
        </div>

      </form>
    </div>
  </div>

</body>
</html>
